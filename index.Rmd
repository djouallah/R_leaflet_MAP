---
title: "New Building Project"
output: 
  flexdashboard::flex_dashboard:
   navbar:
    - { title: "About", href: "https://datamonkeysite.com/", align: right }
    
---

```{r setup, include=FALSE}
library(flexdashboard)
```
charts(altair)
=====================================



```{python,python.reticulate = FALSE}

import altair as alt
import pandas as pd
df=pd.read_csv("qty.csv",parse_dates=[0], dayfirst=True)
select_box = alt.binding_select(options=list(df['category'].unique()))
selection = alt.selection_single(name='y_axis', fields=['category'], bind=select_box)




base = alt.Chart(df).encode(x=alt.X("date:O", timeUnit="yearmonthdate",
                axis=alt.Axis(format="%d %b %y"))).properties(width=1200, height=600)

bar = base.mark_bar().encode(y='sum(Installed_qty)',
                    tooltip=['sum(Installed_qty)']
                    ).add_selection(
    selection 
    
).transform_filter(
    selection
)

line =  base.mark_line(color='red').encode(
                                   y='sum(Installed_qty_cumulative)',
                                   tooltip=['sum(Installed_qty_cumulative)']
                                   
                                   ).transform_filter(
                                   selection

)

chart = alt.layer(
    bar,
    line
     ).resolve_scale(
    y='independent'
    )


chart.save('commodity.html')

```

```{r echo=FALSE}
shiny::includeHTML("commodity.html") 
file.remove("commodity.html")
```

map (leaflet)
=====================================



```{r}
library(readxl)
library(dplyr)
library(leaflet)
library(htmlwidgets)

#read pile  Data

pile_file <- read_excel("pile.xlsx", col_types = c("text","text", "numeric", "numeric","text","text"))


#filter only pile with progress

pile <- filter(pile_file,pile_file$status !="Not Started")

#read json

map_shape <- geojsonio::geojson_read("foundation.json",what = "sp")


#read foundation  data status 

foundation_data <- read_excel("foundation.xlsx", col_types = c("text","text","text", "numeric", "text","text"))

#merge foundation progress status with the shapefile


map_data <- sp::merge(map_shape, foundation_data, by="id")

foundation <-subset(map_data,map_data$structure=="foundation")

road <-subset(map_data,map_data$structure=="road")


#get uniquev values of status and color 

chartlegend <- unique(foundation_data[c("status", "color")])


#define a color palette 

pal <- colorFactor(
  palette = chartlegend$color,
  domain = chartlegend$status,
  ordered = TRUE
)

#define label 

labels <- sprintf(
  "<strong>%s</strong><br/><strong>%s</strong><br/>Progress %g ",
  foundation$description,foundation$status,foundation$progress
) %>% lapply(htmltools::HTML)

#Draw the map

map <-leaflet(map_data) %>%
  setView(lng = mean(pile$x), lat = (min(pile$y)+max(pile$y))/2,zoom = 15) %>%
  
  
  addTiles(urlTemplate = "https://mts1.google.com/vt/lyrs=s&hl=en&src=app&x={x}&y={y}&z={z}&s=G", attribution = 'Google') %>%
  
  addPolygons(data=foundation,fillOpacity = 1,color=foundation$color,label = labels,group="foundation")%>%
  
  addPolygons(data=road,fillOpacity = 1,color=road$color,group="road")%>%
  
  addCircleMarkers(lng = pile$x, lat = pile$y,radius = 3,group="pile")%>%
  
  addLegend(pal = pal, values = chartlegend$status, opacity = 1) %>%

  groupOptions("pile", zoomLevels = 18:21) %>%
  
  addLayersControl(position="topleft",
                 overlayGroups = c("road","foundation"),
                 options = layersControlOptions(collapsed = FALSE)
                  )
  

map

```

table (datatable)
=====================================



```{r}

library(DT)

table <- datatable(foundation_data,rownames = FALSE,extensions = 'Buttons', options = list(
  dom = 'Bfrtip',
  buttons = c('copy', 'excel')
))
table

```


